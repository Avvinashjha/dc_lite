---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import PostCard from '../../../components/PostCard.astro';
import TagList from '../../../components/TagList.astro';
import { getBlogPosts } from '../../../utils/contentLoader';
import { buildTaxonomy, findTaxonomyEntry, slugifyTaxonomy } from '../../../utils/taxonomy';

export function getStaticPaths() {
  const posts = getBlogPosts();
  const entries = buildTaxonomy(posts.flatMap(post => post.tags));
  const paths = new Set<string>();

  entries.forEach(entry => {
    paths.add(entry.slug);
    entry.aliases.forEach(alias => paths.add(alias));
  });

  return Array.from(paths).map(tag => ({ params: { tag } }));
}

const { tag } = Astro.params;
const allPosts = getBlogPosts();
const tagEntries = buildTaxonomy(allPosts.flatMap(post => post.tags));
const entry = findTaxonomyEntry(tagEntries, tag || '');
if (!entry) return Astro.redirect('/blog');
if (tag !== entry.slug) return Astro.redirect(`/blog/tag/${entry.slug}`, 301);

const filtered = allPosts
  .filter(post => post.tags.some(postTag => slugifyTaxonomy(postTag) === entry.slug))
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
---

<BaseLayout
  title={`Posts tagged "${entry.label}" | DailyCoder`}
  description={`Browse all blog posts tagged with ${entry.label}`}
>
  <div class="container" style="padding-top: 3rem; padding-bottom: 3rem;">
    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">
      Posts tagged <span style="color: var(--color-primary);">"{entry.label}"</span>
    </h1>
    <p style="color: var(--color-text-light); font-size: 1.125rem; margin-bottom: 2rem;">
      {filtered.length} post{filtered.length !== 1 ? 's' : ''} found
    </p>
    <TagList currentTag={entry.slug} />
    <div class="grid grid--3">
      {filtered.map(post => (
        <PostCard
          title={post.title} description={post.description} date={new Date(post.date)}
          slug={post.slug} tags={post.tags} category={post.category}
          image={post.image} content={post.content}
        />
      ))}
    </div>
  </div>
</BaseLayout>
