---
import ToolLayout from '../../layouts/ToolLayout.astro';
---

<ToolLayout title="CSV ↔ JSON Converter" description="Convert between CSV and JSON formats — with multiple tabs." toolName="CSV ↔ JSON Converter">
  <div class="tab-bar" id="tab-bar">
    <div class="tab-list" id="tab-list"></div>
    <button class="tab-add" id="btn-add-tab" title="New conversion">+</button>
  </div>

  <div class="tool-actions">
    <button class="tool-btn tool-btn--primary" id="btn-csv2json">CSV → JSON</button>
    <button class="tool-btn tool-btn--primary" id="btn-json2csv">JSON → CSV</button>
    <button class="tool-btn" id="btn-copy">Copy Output</button>
    <button class="tool-btn" id="btn-download">Download</button>
    <button class="tool-btn" id="btn-save">Save Tab</button>
    <button class="tool-btn" id="btn-clear">Clear</button>
  </div>

  <div class="tool-panels">
    <div class="tool-panel">
      <span class="tool-panel__label">Input</span>
      <textarea id="input" class="tool-textarea" placeholder="Paste CSV or JSON here..."></textarea>
    </div>
    <div class="tool-panel">
      <span class="tool-panel__label">Output</span>
      <div id="output" class="tool-output"></div>
    </div>
  </div>
  <div id="status"></div>
</ToolLayout>

<script src="/js/store.js" is:inline></script>
<script is:inline>
  var TOOL = 'csv-json';
  var tabs = [], activeTab = null;
  var input = document.getElementById('input');
  var output = document.getElementById('output');
  var status = document.getElementById('status');
  var lastMode = 'json';

  function genId() { return 'csv-' + Date.now().toString(36); }

  function parseCSV(text) {
    var lines = text.trim().split('\n');
    if (lines.length < 2) throw new Error('CSV needs at least a header row and one data row');
    var headers = lines[0].split(',').map(function(h) { return h.trim().replace(/^"|"$/g, ''); });
    var result = [];
    for (var i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      var vals = lines[i].split(',').map(function(v) { return v.trim().replace(/^"|"$/g, ''); });
      var obj = {};
      headers.forEach(function(h, j) { obj[h] = isNaN(vals[j]) ? vals[j] : Number(vals[j]); });
      result.push(obj);
    }
    return result;
  }

  function jsonToCSV(arr) {
    if (!Array.isArray(arr) || arr.length === 0) throw new Error('JSON must be an array of objects');
    var headers = Object.keys(arr[0]);
    var csv = headers.join(',') + '\n';
    arr.forEach(function(row) {
      csv += headers.map(function(h) {
        var v = row[h] == null ? '' : String(row[h]);
        return v.indexOf(',') >= 0 ? '"' + v + '"' : v;
      }).join(',') + '\n';
    });
    return csv;
  }

  // --- Tab system ---
  function renderTabs() {
    var list = document.getElementById('tab-list');
    list.innerHTML = '';
    tabs.forEach(function(tab) {
      var el = document.createElement('div');
      el.className = 'tab-item' + (tab.id === activeTab ? ' tab-item--active' : '');
      el.innerHTML = '<span class="tab-item__name">' + (tab.name || 'Untitled') + '</span>' +
        (tabs.length > 1 ? '<button class="tab-item__close" data-id="' + tab.id + '">&times;</button>' : '');
      el.addEventListener('click', function(e) { if (!e.target.classList.contains('tab-item__close')) switchTab(tab.id); });
      list.appendChild(el);
    });
    list.querySelectorAll('.tab-item__close').forEach(function(btn) {
      btn.addEventListener('click', function(e) { e.stopPropagation(); closeTab(btn.dataset.id); });
    });
  }

  function switchTab(id) {
    saveCurrentToMemory();
    activeTab = id;
    var tab = tabs.find(function(t) { return t.id === id; });
    if (tab) { input.value = tab.content || ''; output.textContent = tab.output || ''; }
    status.textContent = '';
    renderTabs();
  }

  function saveCurrentToMemory() {
    var tab = tabs.find(function(t) { return t.id === activeTab; });
    if (tab) { tab.content = input.value; tab.output = output.textContent; }
  }

  function addTab(data) {
    var tab = { id: genId(), name: data && data.name || 'Convert ' + (tabs.length + 1), content: data && data.content || '', output: '' };
    tabs.push(tab);
    switchTab(tab.id);
  }

  function closeTab(id) {
    if (tabs.length <= 1) return;
    tabs = tabs.filter(function(t) { return t.id !== id; });
    if (activeTab === id) switchTab(tabs[0].id);
    else renderTabs();
    saveToDB();
  }

  async function saveToDB() {
    saveCurrentToMemory();
    await DCStore.init();
    await DCStore.clear(TOOL);
    for (var i = 0; i < tabs.length; i++)
      await DCStore.set(TOOL, tabs[i].id, { name: tabs[i].name, content: tabs[i].content, order: i, isActive: tabs[i].id === activeTab });
  }

  async function loadFromDB() {
    await DCStore.init();
    var items = await DCStore.getAll(TOOL);
    if (items.length === 0) { addTab({ name: 'Convert 1' }); return; }
    items.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
    tabs = items.map(function(i) { return { id: i.id, name: i.name, content: i.content || '', output: '' }; });
    var active = items.find(function(i) { return i.isActive; });
    activeTab = active ? active.id : tabs[0].id;
    var tab = tabs.find(function(t) { return t.id === activeTab; });
    if (tab) input.value = tab.content;
    renderTabs();
  }

  // --- Actions ---
  document.getElementById('btn-csv2json').addEventListener('click', function() {
    try {
      var result = parseCSV(input.value);
      output.textContent = JSON.stringify(result, null, 2);
      lastMode = 'json';
      status.className = 'tool-success'; status.textContent = 'Converted ' + result.length + ' rows to JSON';
      saveToDB();
    } catch(e) { status.className = 'tool-error'; status.textContent = e.message; }
  });

  document.getElementById('btn-json2csv').addEventListener('click', function() {
    try {
      var csv = jsonToCSV(JSON.parse(input.value));
      output.textContent = csv;
      lastMode = 'csv';
      status.className = 'tool-success'; status.textContent = 'Converted to CSV';
      saveToDB();
    } catch(e) { status.className = 'tool-error'; status.textContent = e.message; }
  });

  document.getElementById('btn-copy').addEventListener('click', function() {
    if (output.textContent) { navigator.clipboard.writeText(output.textContent); status.className = 'tool-success'; status.textContent = 'Copied!'; }
  });

  document.getElementById('btn-download').addEventListener('click', function() {
    if (!output.textContent) return;
    var ext = lastMode === 'csv' ? 'csv' : 'json';
    var blob = new Blob([output.textContent], { type: 'text/' + ext });
    var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    var tab = tabs.find(function(t) { return t.id === activeTab; });
    a.download = (tab ? tab.name : 'converted') + '.' + ext; a.click();
  });

  document.getElementById('btn-save').addEventListener('click', function() {
    var tab = tabs.find(function(t) { return t.id === activeTab; });
    var name = prompt('Tab name:', tab ? tab.name : '');
    if (name !== null && tab) { tab.name = name; renderTabs(); saveToDB(); }
  });

  document.getElementById('btn-add-tab').addEventListener('click', function() { addTab(); saveToDB(); });

  document.getElementById('btn-clear').addEventListener('click', function() {
    input.value = ''; output.textContent = ''; status.textContent = '';
  });

  var st;
  input.addEventListener('input', function() { clearTimeout(st); st = setTimeout(saveToDB, 1000); });

  loadFromDB();
</script>
