---
import ToolLayout from '../../layouts/ToolLayout.astro';
---

<ToolLayout title="Diff Checker" description="Compare two texts and see line-by-line differences." toolName="Diff Checker">
  <div class="tool-actions">
    <button class="tool-btn tool-btn--primary" id="btn-diff">Compare</button>
    <button class="tool-btn" id="btn-clear">Clear</button>
  </div>

  <div class="tool-panels">
    <div class="tool-panel">
      <span class="tool-panel__label">Original</span>
      <textarea id="inputA" class="tool-textarea" placeholder="Paste original text..."></textarea>
    </div>
    <div class="tool-panel">
      <span class="tool-panel__label">Modified</span>
      <textarea id="inputB" class="tool-textarea" placeholder="Paste modified text..."></textarea>
    </div>
  </div>

  <div id="status" style="margin-top: 1rem;"></div>
  <div id="diff-output" style="margin-top: 1rem;"></div>
</ToolLayout>

<script is:inline>
  function computeDiff(a, b) {
    var linesA = a.split('\n'), linesB = b.split('\n');
    var result = [];
    var maxLen = Math.max(linesA.length, linesB.length);
    // Simple line-by-line comparison (LCS would be better but this is fast)
    var i = 0, j = 0;
    while (i < linesA.length || j < linesB.length) {
      if (i < linesA.length && j < linesB.length) {
        if (linesA[i] === linesB[j]) {
          result.push({ type: 'same', lineA: i+1, lineB: j+1, text: linesA[i] });
          i++; j++;
        } else {
          // Look ahead to find if lineA[i] exists later in B
          var foundInB = linesB.indexOf(linesA[i], j+1);
          var foundInA = linesA.indexOf(linesB[j], i+1);
          if (foundInB >= 0 && (foundInA < 0 || foundInB - j <= foundInA - i)) {
            while (j < foundInB) { result.push({ type: 'added', lineB: j+1, text: linesB[j] }); j++; }
          } else if (foundInA >= 0) {
            while (i < foundInA) { result.push({ type: 'removed', lineA: i+1, text: linesA[i] }); i++; }
          } else {
            result.push({ type: 'removed', lineA: i+1, text: linesA[i] });
            result.push({ type: 'added', lineB: j+1, text: linesB[j] });
            i++; j++;
          }
        }
      } else if (i < linesA.length) {
        result.push({ type: 'removed', lineA: i+1, text: linesA[i] }); i++;
      } else {
        result.push({ type: 'added', lineB: j+1, text: linesB[j] }); j++;
      }
    }
    return result;
  }

  document.getElementById('btn-diff').addEventListener('click', function() {
    var a = document.getElementById('inputA').value;
    var b = document.getElementById('inputB').value;
    var status = document.getElementById('status');
    var out = document.getElementById('diff-output');
    if (!a && !b) { status.textContent = ''; out.innerHTML = ''; return; }
    var diff = computeDiff(a, b);
    var adds = diff.filter(function(d){ return d.type==='added'; }).length;
    var rems = diff.filter(function(d){ return d.type==='removed'; }).length;
    status.className = 'tool-success';
    status.textContent = adds === 0 && rems === 0 ? 'No differences found!' : '+' + adds + ' added, -' + rems + ' removed';

    var html = '<div class="diff-lines">';
    diff.forEach(function(d) {
      var cls = d.type === 'added' ? 'dl-added' : d.type === 'removed' ? 'dl-removed' : 'dl-same';
      var prefix = d.type === 'added' ? '+' : d.type === 'removed' ? '-' : ' ';
      var ln = d.lineA || d.lineB || '';
      var esc = (d.text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      html += '<div class="dl ' + cls + '"><span class="dl-ln">' + ln + '</span><span class="dl-pre">' + prefix + '</span><span class="dl-text">' + (esc || '&nbsp;') + '</span></div>';
    });
    out.innerHTML = html + '</div>';
  });

  document.getElementById('btn-clear').addEventListener('click', function() {
    document.getElementById('inputA').value = '';
    document.getElementById('inputB').value = '';
    document.getElementById('diff-output').innerHTML = '';
    document.getElementById('status').textContent = '';
  });
</script>

<style>
  .diff-lines {
    font-family: var(--font-mono); font-size: 0.8rem; border: 1px solid var(--color-border);
    border-radius: var(--radius-md); overflow: hidden;
  }
  .dl {
    display: flex; padding: 0.1rem 0; border-bottom: 1px solid rgba(128,128,128,0.1);
  }
  .dl-ln {
    width: 40px; text-align: right; padding: 0 0.5rem; color: var(--color-text-light);
    font-size: 0.75rem; flex-shrink: 0; user-select: none;
  }
  .dl-pre {
    width: 20px; text-align: center; flex-shrink: 0; font-weight: 700; user-select: none;
  }
  .dl-text { flex: 1; padding-right: 0.5rem; white-space: pre-wrap; word-break: break-all; }
  .dl-same { background: transparent; }
  .dl-added { background: rgba(34,197,94,.1); }
  .dl-added .dl-pre { color: #22c55e; }
  .dl-removed { background: rgba(239,68,68,.1); }
  .dl-removed .dl-pre { color: #ef4444; }
</style>
