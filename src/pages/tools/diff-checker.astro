---
import ToolLayout from '../../layouts/ToolLayout.astro';
---

<ToolLayout title="Diff Checker" description="Compare texts side-by-side â€” with multiple saved diff pairs." toolName="Diff Checker">
  <div class="tab-bar" id="tab-bar">
    <div class="tab-list" id="tab-list"></div>
    <button class="tab-add" id="btn-add-tab" title="New diff pair">+</button>
  </div>

  <div class="tool-actions">
    <button class="tool-btn tool-btn--primary" id="btn-diff">Compare</button>
    <button class="tool-btn" id="btn-swap">Swap</button>
    <button class="tool-btn" id="btn-sample">Load Sample</button>
    <button class="tool-btn" id="btn-save">Save Tab</button>
    <button class="tool-btn" id="btn-clear">Clear</button>
  </div>

  <div class="tool-panels">
    <div class="tool-panel">
      <span class="tool-panel__label">Original</span>
      <textarea id="inputA" class="tool-textarea" placeholder="Paste original text..."></textarea>
    </div>
    <div class="tool-panel">
      <span class="tool-panel__label">Modified</span>
      <textarea id="inputB" class="tool-textarea" placeholder="Paste modified text..."></textarea>
    </div>
  </div>

  <div id="status" style="margin-top: 1rem;"></div>
  <div id="diff-stats" style="display:none; margin-top: 0.75rem;"></div>
  <div id="diff-output" style="margin-top: 1rem;"></div>
</ToolLayout>

<script src="/js/store.js" is:inline></script>
<script is:inline>
  var TOOL = 'diff-checker';
  var tabs = [], activeTab = null;
  var inputA = document.getElementById('inputA');
  var inputB = document.getElementById('inputB');

  function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function genId() { return 'diff-' + Date.now().toString(36); }

  // --- LCS diff ---
  function lcs(a, b) {
    var m=a.length,n=b.length,dp=[];
    for(var i=0;i<=m;i++){dp[i]=[];for(var j=0;j<=n;j++)dp[i][j]=0;}
    for(var i=1;i<=m;i++)for(var j=1;j<=n;j++)dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]+1:Math.max(dp[i-1][j],dp[i][j-1]);
    var res=[],i=m,j=n;
    while(i>0&&j>0){if(a[i-1]===b[j-1]){res.unshift({type:'same',lineA:i,lineB:j,text:a[i-1]});i--;j--;}
    else if(dp[i-1][j]>=dp[i][j-1]){res.unshift({type:'removed',lineA:i,text:a[i-1]});i--;}
    else{res.unshift({type:'added',lineB:j,text:b[j-1]});j--;}}
    while(i>0){res.unshift({type:'removed',lineA:i,text:a[i-1]});i--;}
    while(j>0){res.unshift({type:'added',lineB:j,text:b[j-1]});j--;}
    return res;
  }

  function renderSideBySide(diff) {
    var left=[],right=[],adds=0,rems=0,same=0;
    diff.forEach(function(d){if(d.type==='same'){left.push({num:d.lineA,text:d.text,type:'same'});right.push({num:d.lineB,text:d.text,type:'same'});same++;}
    else if(d.type==='removed'){left.push({num:d.lineA,text:d.text,type:'removed'});right.push({num:'',text:'',type:'empty'});rems++;}
    else{left.push({num:'',text:'',type:'empty'});right.push({num:d.lineB,text:d.text,type:'added'});adds++;}});
    for(var i=0;i<left.length;i++){if(left[i].type==='removed'&&right[i].type==='empty'){for(var j=i+1;j<left.length&&j<i+4;j++){if(left[j].type==='empty'&&right[j].type==='added'){right[i]=right[j];right[i].type='changed-add';left[i].type='changed-rem';left[j]={num:'',text:'',type:'empty'};right[j]={num:'',text:'',type:'empty'};break;}}}}
    var fl=[],fr=[];for(var i=0;i<left.length;i++){if(left[i].type==='empty'&&right[i].type==='empty')continue;fl.push(left[i]);fr.push(right[i]);}
    return{left:fl,right:fr,adds:adds,rems:rems,same:same};
  }

  function lineClass(t){if(t==='removed'||t==='changed-rem')return 'jd-rem';if(t==='added'||t==='changed-add')return 'jd-add';if(t==='empty')return 'jd-empty';return '';}

  function buildHtml(left, right) {
    var h='<div class="jd-wrap"><div class="jd-side jd-side--left"><div class="jd-header">Original</div>';
    left.forEach(function(l){h+='<div class="jd-line '+lineClass(l.type)+'"><span class="jd-num">'+(l.num||'')+'</span><span class="jd-pre">'+(l.type==='removed'||l.type==='changed-rem'?'-':' ')+'</span><span class="jd-code">'+esc(l.text)+'</span></div>';});
    h+='</div><div class="jd-side jd-side--right"><div class="jd-header">Modified</div>';
    right.forEach(function(r){h+='<div class="jd-line '+lineClass(r.type)+'"><span class="jd-num">'+(r.num||'')+'</span><span class="jd-pre">'+(r.type==='added'||r.type==='changed-add'?'+':' ')+'</span><span class="jd-code">'+esc(r.text)+'</span></div>';});
    return h+'</div></div>';
  }

  // --- Tab system ---
  function renderTabs() {
    var list = document.getElementById('tab-list');
    list.innerHTML = '';
    tabs.forEach(function(tab) {
      var el = document.createElement('div');
      el.className = 'tab-item' + (tab.id === activeTab ? ' tab-item--active' : '');
      el.innerHTML = '<span class="tab-item__name">' + (tab.name || 'Untitled') + '</span>' +
        (tabs.length > 1 ? '<button class="tab-item__close" data-id="' + tab.id + '">&times;</button>' : '');
      el.addEventListener('click', function(e) { if (!e.target.classList.contains('tab-item__close')) switchTab(tab.id); });
      list.appendChild(el);
    });
    list.querySelectorAll('.tab-item__close').forEach(function(btn) {
      btn.addEventListener('click', function(e) { e.stopPropagation(); closeTab(btn.dataset.id); });
    });
  }

  function switchTab(id) {
    saveCurrentToMemory();
    activeTab = id;
    var tab = tabs.find(function(t) { return t.id === id; });
    if (tab) { inputA.value = tab.original || ''; inputB.value = tab.modified || ''; }
    document.getElementById('diff-output').innerHTML = '';
    document.getElementById('diff-stats').style.display = 'none';
    document.getElementById('status').textContent = '';
    renderTabs();
  }

  function saveCurrentToMemory() {
    var tab = tabs.find(function(t) { return t.id === activeTab; });
    if (tab) { tab.original = inputA.value; tab.modified = inputB.value; }
  }

  function addTab(data) {
    var tab = { id: genId(), name: data && data.name || 'Diff ' + (tabs.length + 1), original: data && data.original || '', modified: data && data.modified || '' };
    tabs.push(tab);
    switchTab(tab.id);
  }

  function closeTab(id) {
    if (tabs.length <= 1) return;
    tabs = tabs.filter(function(t) { return t.id !== id; });
    if (activeTab === id) switchTab(tabs[0].id);
    else renderTabs();
    saveToDB();
  }

  async function saveToDB() {
    saveCurrentToMemory();
    await DCStore.init();
    await DCStore.clear(TOOL);
    for (var i = 0; i < tabs.length; i++) {
      await DCStore.set(TOOL, tabs[i].id, { name: tabs[i].name, original: tabs[i].original, modified: tabs[i].modified, order: i, isActive: tabs[i].id === activeTab });
    }
  }

  async function loadFromDB() {
    await DCStore.init();
    var items = await DCStore.getAll(TOOL);
    if (items.length === 0) { addTab({ name: 'Diff 1' }); return; }
    items.sort(function(a, b) { return (a.order || 0) - (b.order || 0); });
    tabs = items.map(function(i) { return { id: i.id, name: i.name, original: i.original || '', modified: i.modified || '' }; });
    var active = items.find(function(i) { return i.isActive; });
    activeTab = active ? active.id : tabs[0].id;
    var tab = tabs.find(function(t) { return t.id === activeTab; });
    if (tab) { inputA.value = tab.original; inputB.value = tab.modified; }
    renderTabs();
  }

  // --- Actions ---
  document.getElementById('btn-diff').addEventListener('click', function() {
    var status = document.getElementById('status'), out = document.getElementById('diff-output'), stats = document.getElementById('diff-stats');
    var a = inputA.value, b = inputB.value;
    if (!a && !b) return;
    var diff = lcs(a.split('\n'), b.split('\n'));
    var result = renderSideBySide(diff);
    if (result.adds === 0 && result.rems === 0) {
      status.className = 'tool-success'; status.textContent = 'Texts are identical.';
      stats.style.display = 'none';
      out.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--color-text-light);border:1px dashed var(--color-border);border-radius:var(--radius-md);">Identical</div>';
    } else {
      status.className = 'tool-success'; status.textContent = 'Comparison complete';
      stats.style.display = 'flex';
      stats.innerHTML = '<span class="jd-stat jd-stat--add">+' + result.adds + ' added</span><span class="jd-stat jd-stat--rem">-' + result.rems + ' removed</span><span class="jd-stat jd-stat--same">' + result.same + ' unchanged</span>';
      out.innerHTML = buildHtml(result.left, result.right);
      var ls = out.querySelector('.jd-side--left'), rs = out.querySelector('.jd-side--right'), s = false;
      ls.addEventListener('scroll', function() { if (!s) { s = true; rs.scrollTop = ls.scrollTop; s = false; } });
      rs.addEventListener('scroll', function() { if (!s) { s = true; ls.scrollTop = rs.scrollTop; s = false; } });
    }
    saveToDB();
  });

  document.getElementById('btn-swap').addEventListener('click', function() {
    var tmp = inputA.value; inputA.value = inputB.value; inputB.value = tmp;
  });

  document.getElementById('btn-sample').addEventListener('click', function() {
    inputA.value = 'function greet(name) {\n  console.log("Hello, " + name);\n  return true;\n}\n\nconst users = ["Alice", "Bob"];\n\nusers.forEach(function(user) {\n  greet(user);\n});';
    inputB.value = 'function greet(name, greeting) {\n  const message = `${greeting}, ${name}!`;\n  console.log(message);\n  return message;\n}\n\nconst users = ["Alice", "Bob", "Charlie"];\n\nusers.forEach((user) => {\n  greet(user, "Hi");\n});';
  });

  document.getElementById('btn-save').addEventListener('click', function() {
    var tab = tabs.find(function(t) { return t.id === activeTab; });
    var name = prompt('Tab name:', tab ? tab.name : '');
    if (name !== null && tab) { tab.name = name; renderTabs(); saveToDB(); }
  });

  document.getElementById('btn-add-tab').addEventListener('click', function() { addTab(); saveToDB(); });

  document.getElementById('btn-clear').addEventListener('click', function() {
    inputA.value = ''; inputB.value = '';
    document.getElementById('diff-output').innerHTML = '';
    document.getElementById('diff-stats').style.display = 'none';
    document.getElementById('status').textContent = '';
  });

  // Auto-save
  var st;
  inputA.addEventListener('input', function() { clearTimeout(st); st = setTimeout(saveToDB, 1000); });
  inputB.addEventListener('input', function() { clearTimeout(st); st = setTimeout(saveToDB, 1000); });

  loadFromDB();
</script>
