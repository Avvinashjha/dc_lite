---
import ToolLayout from '../../layouts/ToolLayout.astro';
---

<ToolLayout title="Timezone Converter" description="Convert time between timezones instantly." toolName="Timezone Converter">
  <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 1.25rem; text-align: center; margin-bottom: 2rem;">
    <span class="tool-panel__label">Your Local Time</span>
    <div id="local-time" style="font-size: 1.75rem; font-weight: 700; font-family: var(--font-mono); margin: 0.5rem 0;"></div>
    <div id="local-tz" style="font-size: 0.85rem; color: var(--color-text-light);"></div>
  </div>

  <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 1rem; align-items: end; margin-bottom: 2rem;">
    <div>
      <span class="tool-panel__label">From</span>
      <select id="from-tz" class="tool-input"></select>
      <input id="from-time" class="tool-input" type="datetime-local" style="margin-top: 0.5rem;" />
    </div>
    <div style="text-align: center; padding-bottom: 0.5rem;">
      <button class="tool-btn" id="btn-swap" style="font-size: 1.2rem;">⇄</button>
    </div>
    <div>
      <span class="tool-panel__label">To</span>
      <select id="to-tz" class="tool-input"></select>
      <div id="result-time" class="tool-input" style="margin-top: 0.5rem; min-height: 40px; display: flex; align-items: center; font-weight: 700; font-family: var(--font-mono);"></div>
    </div>
  </div>

  <div id="world-clocks" style="margin-top: 2rem;"></div>
</ToolLayout>

<script is:inline>
  var zones = Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : [
    'UTC','America/New_York','America/Chicago','America/Denver','America/Los_Angeles',
    'Europe/London','Europe/Paris','Europe/Berlin','Asia/Tokyo','Asia/Shanghai',
    'Asia/Kolkata','Asia/Dubai','Australia/Sydney','Pacific/Auckland'
  ];

  var popularZones = ['UTC','America/New_York','America/Los_Angeles','Europe/London','Europe/Paris','Asia/Kolkata','Asia/Tokyo','Asia/Shanghai','Australia/Sydney'];
  var localTz = Intl.DateTimeFormat().resolvedOptions().timeZone;

  function populateSelect(el, selected) {
    el.innerHTML = '';
    // Add popular first
    var optGroup = document.createElement('optgroup');
    optGroup.label = 'Popular';
    popularZones.forEach(function(tz) {
      var opt = document.createElement('option');
      opt.value = tz; opt.textContent = tz.replace(/_/g, ' ');
      if (tz === selected) opt.selected = true;
      optGroup.appendChild(opt);
    });
    el.appendChild(optGroup);

    var allGroup = document.createElement('optgroup');
    allGroup.label = 'All Timezones';
    zones.forEach(function(tz) {
      var opt = document.createElement('option');
      opt.value = tz; opt.textContent = tz.replace(/_/g, ' ');
      if (tz === selected) opt.selected = true;
      allGroup.appendChild(opt);
    });
    el.appendChild(allGroup);
  }

  var fromTz = document.getElementById('from-tz');
  var toTz = document.getElementById('to-tz');
  var fromTime = document.getElementById('from-time');
  var resultTime = document.getElementById('result-time');

  populateSelect(fromTz, localTz);
  populateSelect(toTz, 'UTC');

  // Set current time
  var now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  fromTime.value = now.toISOString().slice(0, 16);

  function convert() {
    var dt = new Date(fromTime.value);
    if (isNaN(dt)) { resultTime.textContent = '—'; return; }
    // Format in target timezone
    var opts = { timeZone: toTz.value, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
    try {
      resultTime.textContent = dt.toLocaleString('en-GB', opts);
    } catch(e) { resultTime.textContent = 'Error'; }
  }

  fromTz.addEventListener('change', convert);
  toTz.addEventListener('change', convert);
  fromTime.addEventListener('input', convert);
  convert();

  document.getElementById('btn-swap').addEventListener('click', function() {
    var tmp = fromTz.value; fromTz.value = toTz.value; toTz.value = tmp; convert();
  });

  // Live clock
  function tick() {
    var n = new Date();
    document.getElementById('local-time').textContent = n.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('local-tz').textContent = localTz.replace(/_/g, ' ') + ' (UTC' + (n.getTimezoneOffset() > 0 ? '-' : '+') + Math.abs(n.getTimezoneOffset() / 60) + ')';

    // World clocks
    var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.75rem;">';
    popularZones.forEach(function(tz) {
      var time = n.toLocaleTimeString('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      var date = n.toLocaleDateString('en-GB', { timeZone: tz, weekday: 'short', month: 'short', day: 'numeric' });
      html += '<div style="background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-md);padding:0.6rem 0.75rem;">' +
        '<div style="font-size:0.7rem;color:var(--color-text-light);text-transform:uppercase;letter-spacing:0.04em;">' + tz.replace(/_/g, ' ') + '</div>' +
        '<div style="font-family:var(--font-mono);font-size:1.1rem;font-weight:700;">' + time + '</div>' +
        '<div style="font-size:0.75rem;color:var(--color-text-light);">' + date + '</div></div>';
    });
    document.getElementById('world-clocks').innerHTML = html + '</div>';
  }
  tick(); setInterval(tick, 1000);
</script>

<style>
  @media (max-width: 640px) {
    div[style*="grid-template-columns: 1fr auto 1fr"] {
      display: flex !important;
      flex-direction: column;
    }
  }
</style>
