---
import ToolLayout from '../../layouts/ToolLayout.astro';
---

<ToolLayout title="Markdown Preview" description="Write markdown and see a live rendered preview." toolName="Markdown Preview">
  <div class="tool-actions">
    <button class="tool-btn tool-btn--primary" id="btn-pdf">Download PDF</button>
    <button class="tool-btn" id="btn-copy-html">Copy HTML</button>
    <button class="tool-btn" id="btn-download-html">Download HTML</button>
    <button class="tool-btn" id="btn-download-md">Download .md</button>
    <button class="tool-btn" id="btn-clear">Clear</button>
  </div>

  <div class="tool-panels">
    <div class="tool-panel">
      <span class="tool-panel__label">Markdown Input</span>
      <textarea id="input" class="tool-textarea" style="min-height: 400px;"></textarea>
    </div>
    <div class="tool-panel">
      <span class="tool-panel__label">Preview</span>
      <div id="preview" class="md-preview"></div>
    </div>
  </div>
</ToolLayout>

<script is:inline>
  // Minimal markdown parser (no library needed for basic preview)
  function parseMd(md) {
    var html = md
      // Code blocks
      .replace(/```(\w*)\n([\s\S]*?)```/g, function(m, lang, code) {
        return '<pre><code class="language-' + lang + '">' + code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>';
      })
      // Tables
      .replace(/^\|(.+)\|\s*\n\|[-| :]+\|\s*\n((?:\|.+\|\s*\n?)*)/gm, function(m, header, body) {
        var ths = header.split('|').map(function(h) { return '<th>' + h.trim() + '</th>'; }).join('');
        var rows = body.trim().split('\n').map(function(row) {
          var tds = row.replace(/^\||\|$/g, '').split('|').map(function(c) { return '<td>' + c.trim() + '</td>'; }).join('');
          return '<tr>' + tds + '</tr>';
        }).join('');
        return '<table><thead><tr>' + ths + '</tr></thead><tbody>' + rows + '</tbody></table>';
      })
      // Headers
      .replace(/^######\s+(.+)$/gm, '<h6>$1</h6>')
      .replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>')
      .replace(/^####\s+(.+)$/gm, '<h4>$1</h4>')
      .replace(/^###\s+(.+)$/gm, '<h3>$1</h3>')
      .replace(/^##\s+(.+)$/gm, '<h2>$1</h2>')
      .replace(/^#\s+(.+)$/gm, '<h1>$1</h1>')
      // Blockquotes
      .replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>')
      // Bold, italic, inline code
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      // Links, images
      .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" />')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
      // Unordered lists
      .replace(/^[-*]\s+(.+)$/gm, '<li>$1</li>')
      // Horizontal rule
      .replace(/^---$/gm, '<hr />')
      // Paragraphs
      .replace(/\n\n/g, '</p><p>')
      .replace(/^(?!<[hupoltbr])/gm, '');
    // Wrap loose li in ul
    html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
    return '<div class="article__content">' + html + '</div>';
  }

  var input = document.getElementById('input');
  var preview = document.getElementById('preview');

  // Default sample
  input.value = "# Hello World\n\nThis is **bold** and *italic*.\n\n## Code Example\n\n```javascript\nfunction greet(n) {\n  console.log('Hello, ' + n);\n}\n```\n\n## List\n\n- Item one\n- Item two\n- Item three\n\n> A blockquote for emphasis.\n\n[Visit DailyCoder](https://dailycoder.in)\n\n| Header 1 | Header 2 |\n|----------|----------|\n| Cell 1   | Cell 2   |";

  function render() { preview.innerHTML = parseMd(input.value); }
  input.addEventListener('input', render);
  render();

  document.getElementById('btn-copy-html').addEventListener('click', function() {
    navigator.clipboard.writeText(preview.innerHTML);
    var btn = this; btn.textContent = 'Copied!'; setTimeout(function() { btn.textContent = 'Copy HTML'; }, 2000);
  });

  document.getElementById('btn-pdf').addEventListener('click', function() {
    var content = preview.innerHTML;
    var win = window.open('', '_blank');
    win.document.write('<!DOCTYPE html><html><head><title>Markdown PDF</title><style>' +
      'body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;max-width:800px;margin:2rem auto;padding:0 1.5rem;color:#1f2937;line-height:1.7;}' +
      'h1,h2,h3,h4{margin-top:1.5em;margin-bottom:0.5em;}' +
      'pre{background:#f3f4f6;padding:1rem;border-radius:6px;overflow-x:auto;font-size:0.85rem;}' +
      'code{font-family:SFMono-Regular,Menlo,monospace;font-size:0.85em;background:#f3f4f6;padding:0.15em 0.3em;border-radius:3px;}' +
      'pre code{background:none;padding:0;}' +
      'blockquote{border-left:3px solid #2563eb;padding-left:1rem;color:#6b7280;font-style:italic;margin:1rem 0;}' +
      'table{border-collapse:collapse;width:100%;margin:1rem 0;}' +
      'th,td{border:1px solid #e5e7eb;padding:0.5rem 0.75rem;text-align:left;}' +
      'th{background:#f9fafb;font-weight:600;}' +
      'img{max-width:100%;}' +
      'hr{border:none;border-top:1px solid #e5e7eb;margin:1.5rem 0;}' +
      '@media print{body{margin:0;padding:1rem;}}' +
      '</style></head><body>' + content + '</body></html>');
    win.document.close();
    setTimeout(function() { win.print(); }, 300);
  });

  document.getElementById('btn-download-html').addEventListener('click', function() {
    var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Document</title></head><body>' + preview.innerHTML + '</body></html>';
    var blob = new Blob([html], { type: 'text/html' });
    var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'document.html'; a.click();
  });

  document.getElementById('btn-download-md').addEventListener('click', function() {
    var blob = new Blob([input.value], { type: 'text/markdown' });
    var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'document.md'; a.click();
  });

  document.getElementById('btn-clear').addEventListener('click', function() {
    input.value = ''; preview.innerHTML = '';
  });
</script>

<style>
  .md-preview {
    min-height: 400px; padding: 1rem; border: 1px solid var(--color-border);
    border-radius: var(--radius-md); background: var(--color-surface);
    overflow: auto; font-size: 0.9rem; line-height: 1.7;
  }
  .md-preview :global(table) {
    width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.85rem;
  }
  .md-preview :global(th), .md-preview :global(td) {
    border: 1px solid var(--color-border); padding: 0.5rem 0.75rem; text-align: left;
  }
  .md-preview :global(th) { background: var(--color-code-bg); font-weight: 600; }
  .md-preview :global(blockquote) {
    border-left: 3px solid var(--color-primary); padding-left: 1rem;
    color: var(--color-text-light); margin: 1rem 0; font-style: italic;
  }
  .md-preview :global(pre) {
    background: #1e293b; color: #e2e8f0; padding: 0.75rem;
    border-radius: var(--radius-md); overflow-x: auto; margin: 1rem 0;
  }
  .md-preview :global(hr) { border: none; border-top: 1px solid var(--color-border); margin: 1.5rem 0; }
</style>
