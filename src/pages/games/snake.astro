---
import GameLayout from '../../layouts/GameLayout.astro';
---
<GameLayout gameName="Snake" description="Classic snake game â€” eat food, grow longer, don't hit yourself!" instructions="Use <strong>arrow keys</strong> or <strong>swipe</strong> on mobile to move the snake. Eat the red food to grow. Don't hit the walls or yourself!" keywords="snake game, classic snake, browser snake">
  <canvas id="game"></canvas>
</GameLayout>
<script is:inline>
(function(){
  var c = document.getElementById('game'), ctx = c.getContext('2d');
  var dpr = window.devicePixelRatio || 1;
  var cols = 20, rows = 20;

  // Size canvas to fit container
  function resize() {
    var container = c.parentElement;
    var maxW = Math.min(container.clientWidth, 500);
    var S = Math.floor(maxW / cols);
    var W = S * cols, H = S * rows;
    c.width = W * dpr; c.height = H * dpr;
    c.style.width = W + 'px'; c.style.height = H + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    return S;
  }

  var S = resize(), W = S * cols, H = S * rows;
  var snake, dir, food, score, best, running, interval, gameOver;
  var BEST_KEY = 'dc_snake_best';
  best = parseInt(localStorage.getItem(BEST_KEY)) || 0;
  document.getElementById('best-score').textContent = best;

  function recalc() {
    S = resize(); W = S * cols; H = S * rows;
    draw();
  }
  window.addEventListener('resize', recalc);

  function init() {
    snake = [{ x: Math.floor(cols/2), y: Math.floor(rows/2) }];
    dir = { x: 1, y: 0 }; food = null; score = 0; gameOver = false; running = false;
    placeFood(); updateScore(); recalc();
  }
  function placeFood() {
    do { food = { x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows) }; }
    while (snake.some(function(s) { return s.x === food.x && s.y === food.y; }));
  }
  function updateScore() {
    document.getElementById('score').textContent = score;
    if (score > best) { best = score; localStorage.setItem(BEST_KEY, best); document.getElementById('best-score').textContent = best; }
  }
  function draw() {
    ctx.fillStyle = '#111827'; ctx.fillRect(0, 0, W, H);
    // Grid
    ctx.strokeStyle = '#1f2937'; ctx.lineWidth = 0.5;
    for (var i = 0; i < cols; i++) { ctx.beginPath(); ctx.moveTo(i*S, 0); ctx.lineTo(i*S, H); ctx.stroke(); }
    for (var i = 0; i < rows; i++) { ctx.beginPath(); ctx.moveTo(0, i*S); ctx.lineTo(W, i*S); ctx.stroke(); }
    // Snake
    snake.forEach(function(s, i) {
      ctx.fillStyle = i === 0 ? '#22c55e' : '#16a34a';
      ctx.beginPath();
      ctx.roundRect(s.x*S+1, s.y*S+1, S-2, S-2, 3);
      ctx.fill();
    });
    // Food
    if (food) {
      ctx.fillStyle = '#ef4444';
      ctx.beginPath(); ctx.arc(food.x*S+S/2, food.y*S+S/2, S/2-2, 0, Math.PI*2); ctx.fill();
    }
    if (gameOver) {
      ctx.fillStyle = 'rgba(0,0,0,0.65)'; ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#fff'; ctx.font = 'bold ' + Math.max(18, S*1.2) + 'px sans-serif';
      ctx.textAlign = 'center'; ctx.fillText('Game Over!', W/2, H/2-S*0.5);
      ctx.font = Math.max(14, S*0.7) + 'px sans-serif';
      ctx.fillText('Score: ' + score, W/2, H/2+S*0.7);
    }
  }
  function step() {
    var head = { x: snake[0].x+dir.x, y: snake[0].y+dir.y };
    if (head.x<0 || head.x>=cols || head.y<0 || head.y>=rows || snake.some(function(s) { return s.x===head.x && s.y===head.y; })) {
      gameOver = true; running = false; clearInterval(interval);
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-restart').style.display = '';
      document.getElementById('btn-pause').style.display = 'none';
      draw(); return;
    }
    snake.unshift(head);
    if (head.x === food.x && head.y === food.y) { score++; updateScore(); placeFood(); }
    else snake.pop();
    draw();
  }
  function start() {
    if (running) return; running = true;
    document.getElementById('btn-start').style.display = 'none';
    document.getElementById('btn-pause').style.display = '';
    interval = setInterval(step, 120);
  }
  function restart() { clearInterval(interval); init(); start(); document.getElementById('btn-restart').style.display = 'none'; }

  document.getElementById('btn-start').onclick = start;
  document.getElementById('btn-restart').onclick = restart;
  document.getElementById('btn-pause').onclick = function() {
    if (running) { clearInterval(interval); running = false; this.textContent = 'Resume'; }
    else { interval = setInterval(step, 120); running = true; this.textContent = 'Pause'; }
  };
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowUp' && dir.y !== 1) dir = { x:0, y:-1 };
    else if (e.key === 'ArrowDown' && dir.y !== -1) dir = { x:0, y:1 };
    else if (e.key === 'ArrowLeft' && dir.x !== 1) dir = { x:-1, y:0 };
    else if (e.key === 'ArrowRight' && dir.x !== -1) dir = { x:1, y:0 };
    if (!running && !gameOver) start();
  });
  // Touch
  var tx, ty;
  c.addEventListener('touchstart', function(e) { var t = e.touches[0]; tx = t.clientX; ty = t.clientY; e.preventDefault(); }, { passive: false });
  c.addEventListener('touchend', function(e) {
    var t = e.changedTouches[0]; var dx = t.clientX-tx, dy = t.clientY-ty;
    if (Math.abs(dx) > Math.abs(dy)) { if (dx>0 && dir.x!==-1) dir={x:1,y:0}; else if (dx<0 && dir.x!==1) dir={x:-1,y:0}; }
    else { if (dy>0 && dir.y!==-1) dir={x:0,y:1}; else if (dy<0 && dir.y!==1) dir={x:0,y:-1}; }
    if (!running && !gameOver) start();
  });
  // roundRect polyfill
  if (!ctx.roundRect) ctx.roundRect = function(x,y,w,h,r) { this.moveTo(x+r,y); this.lineTo(x+w-r,y); this.arcTo(x+w,y,x+w,y+r,r); this.lineTo(x+w,y+h-r); this.arcTo(x+w,y+h,x+w-r,y+h,r); this.lineTo(x+r,y+h); this.arcTo(x,y+h,x,y+h-r,r); this.lineTo(x,y+r); this.arcTo(x,y,x+r,y,r); };
  init();
})();
</script>
