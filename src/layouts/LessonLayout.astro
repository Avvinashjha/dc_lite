---
import BaseLayout from "./BaseLayout.astro";
import VideoEmbed from "../components/VideoEmbed.astro";
import Quiz from "../components/Quiz.astro";
import Exercise from "../components/Exercise.astro";
import { parseMarkdown } from "../utils/markdown";
import { extractBlocks } from "../utils/parseBlocks";
import type { Course, Lesson } from "../types/post";

interface Props {
  lesson: Lesson;
  course: Course;
  prevLesson?: {
    courseSlug: string;
    moduleSlug: string;
    slug: string;
    title: string;
  } | null;
  nextLesson?: {
    courseSlug: string;
    moduleSlug: string;
    slug: string;
    title: string;
  } | null;
}

const { lesson, course, prevLesson, nextLesson } = Astro.props;
const { cleanMarkdown, blocks } = extractBlocks(lesson.content);
const htmlParts = parseMarkdown(cleanMarkdown).split(/<!--BLOCK_(\d+)-->/);
---

<BaseLayout
  title={`${lesson.title} | ${course.title} | DailyCoder`}
  description={`${lesson.title} - ${course.title}`}
  breadcrumbs={[
    { label: "Home", href: "/" },
    { label: "Courses", href: "/courses" },
    { label: course.title, href: `/courses/${course.slug}` },
    { label: lesson.title, href: Astro.url.pathname },
  ]}
>
  <div class="lesson-layout">
    <!-- Sidebar -->
    <aside class="lesson-sidebar">
      <a href={`/courses/${course.slug}`} class="lesson-sidebar__back"
        >&larr; {course.title}</a
      >
      {
        course.resolvedModules.map((mod) => (
          <div class="lesson-sidebar__module">
            <h4 class="lesson-sidebar__module-title">{mod.title}</h4>
            <ul class="lesson-sidebar__lessons">
              {mod.lessons.map((l) => (
                <li>
                  <a
                    href={`/courses/${course.slug}/${mod.slug}/${l.slug}`}
                    class={`lesson-sidebar__link ${l.slug === lesson.slug && mod.slug === lesson.moduleSlug ? "lesson-sidebar__link--active" : ""}`}
                  >
                    {l.type === "video" ? "â–¶" : "ðŸ“„"} {l.title}
                    <span class="lesson-sidebar__duration">{l.duration}</span>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))
      }
    </aside>

    <!-- Content -->
    <article class="lesson-content">
      <div class="lesson-content__header">
        <span class="tag" style="text-transform: capitalize;"
          >{lesson.type}</span
        >
        <span style="color: var(--color-text-light); font-size: 0.875rem;"
          >{lesson.duration}</span
        >
      </div>

      <div class="article__content">
        {
          htmlParts.map((part, i) => {
            if (i % 2 === 0) {
              return <div set:html={part} />;
            }
            const blockIdx = parseInt(part);
            const block = blocks[blockIdx];
            if (!block) return null;
            if (block.type === "video")
              return <VideoEmbed url={block.url} title={block.title} />;
            if (block.type === "quiz")
              return (
                <Quiz
                  question={block.question}
                  options={block.options}
                  answer={block.answer}
                  explanation={block.explanation}
                />
              );
            if (block.type === "exercise")
              return (
                <Exercise
                  title={block.title}
                  description={block.description}
                  starterCode={block.starterCode}
                />
              );
            return null;
          })
        }
      </div>

      <!-- Nav -->
      <div class="lesson-nav">
        {
          prevLesson ? (
            <a
              href={`/courses/${prevLesson.courseSlug}/${prevLesson.moduleSlug}/${prevLesson.slug}`}
              class="button button--secondary"
            >
              &larr; {prevLesson.title}
            </a>
          ) : (
            <span />
          )
        }
        {
          nextLesson ? (
            <a
              href={`/courses/${nextLesson.courseSlug}/${nextLesson.moduleSlug}/${nextLesson.slug}`}
              class="button"
            >
              {nextLesson.title} &rarr;
            </a>
          ) : (
            <a href={`/courses/${course.slug}`} class="button">
              Back to Course
            </a>
          )
        }
      </div>
    </article>
  </div>
</BaseLayout>

<style>
  .lesson-layout {
    display: flex;
    min-height: calc(100vh - 160px);
    max-width: 100vw;
    overflow-x: hidden;
  }
  .lesson-sidebar {
    width: 280px;
    flex-shrink: 0;
    background: var(--color-surface);
    border-right: 1px solid var(--color-border);
    padding: var(--spacing-lg);
    overflow-y: auto;
    position: sticky;
    top: 52px;
    height: calc(100vh - 52px);
  }
  .lesson-sidebar__back {
    display: block;
    margin-bottom: var(--spacing-lg);
    color: var(--color-text-light);
    font-size: 0.85rem;
  }
  .lesson-sidebar__back:hover {
    color: var(--color-primary);
    text-decoration: none;
  }
  .lesson-sidebar__module {
    margin-bottom: var(--spacing-lg);
  }
  .lesson-sidebar__module-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--color-text-light);
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }
  .lesson-sidebar__lessons {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .lesson-sidebar__link {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.6rem;
    border-radius: var(--radius-md);
    font-size: 0.8rem;
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition-fast);
  }
  .lesson-sidebar__link:hover {
    background: var(--color-code-bg);
    text-decoration: none;
  }
  .lesson-sidebar__link--active {
    background: var(--color-primary);
    color: white;
  }
  .lesson-sidebar__link--active:hover {
    background: var(--color-primary-dark);
  }
  .lesson-sidebar__duration {
    margin-left: auto;
    font-size: 0.7rem;
    opacity: 0.7;
    white-space: nowrap;
  }
  .lesson-content {
    flex: 1;
    padding: var(--spacing-2xl);
    max-width: var(--content-max-width);
    margin: 0 auto;
    min-width: 0;
    overflow-x: hidden;
  }
  .lesson-content__header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: var(--spacing-lg);
  }
  .lesson-nav {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: 1px solid var(--color-border);
  }
  .lesson-nav .button {
    font-size: 0.8rem;
    padding: 0.6rem 1rem;
    max-width: 50%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Mobile: hide sidebar, show toggle */
  @media (max-width: 900px) {
    .lesson-layout {
      flex-direction: column;
    }
    .lesson-sidebar {
      width: 100%;
      position: static;
      height: auto;
      border-right: none;
      border-bottom: 1px solid var(--color-border);
      padding: var(--spacing-md) var(--spacing-lg);
      max-height: 50vh;
      overflow-y: auto;
    }
    .lesson-content {
      padding: var(--spacing-lg);
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }
    .lesson-nav {
      flex-direction: column;
      gap: 0.75rem;
    }
    .lesson-nav .button {
      max-width: 100%;
      text-align: center;
    }
  }
</style>
